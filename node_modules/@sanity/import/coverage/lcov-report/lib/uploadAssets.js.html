<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for lib/uploadAssets.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">All files</a> / <a href="index.html">lib</a> uploadAssets.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">6.29% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>11/175</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/54</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>0/45</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">7.97% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>11/138</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span></td><td class="text"><pre class="prettyprint lang-js">"use strict";
&nbsp;
function <span class="fstat-no" title="function not covered" >_slicedToArray(</span>arr, i) { <span class="cstat-no" title="statement not covered" >return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _nonIterableRest(); </span>}
&nbsp;
function <span class="fstat-no" title="function not covered" >_nonIterableRest(</span>) { <span class="cstat-no" title="statement not covered" >throw new TypeError("Invalid attempt to destructure non-iterable instance"); </span>}
&nbsp;
function <span class="fstat-no" title="function not covered" >_iterableToArrayLimit(</span>arr, i) { var _arr = <span class="cstat-no" title="statement not covered" >[];</span> var _n = <span class="cstat-no" title="statement not covered" >true;</span> var _d = <span class="cstat-no" title="statement not covered" >false;</span> var _e = <span class="cstat-no" title="statement not covered" >undefined;</span> <span class="cstat-no" title="statement not covered" >try { <span class="cstat-no" title="statement not covered" >for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { <span class="cstat-no" title="statement not covered" >_arr.push(_s.value); <span class="cstat-no" title="statement not covered" ></span>if (i &amp;&amp; _arr.length === i) <span class="cstat-no" title="statement not covered" >break; </span></span>} </span>} catch (err) { <span class="cstat-no" title="statement not covered" >_d = true; <span class="cstat-no" title="statement not covered" ></span>_e = err; </span>} finally { <span class="cstat-no" title="statement not covered" >try { <span class="cstat-no" title="statement not covered" >if (!_n &amp;&amp; _i["return"] != null) <span class="cstat-no" title="statement not covered" >_i["return"](); </span></span>} finally { <span class="cstat-no" title="statement not covered" >if (_d) <span class="cstat-no" title="statement not covered" >throw _e; </span></span>} </span>} <span class="cstat-no" title="statement not covered" ></span>return _arr; </span>}
&nbsp;
function <span class="fstat-no" title="function not covered" >_arrayWithHoles(</span>arr) { <span class="cstat-no" title="statement not covered" >if (Array.isArray(arr)) <span class="cstat-no" title="statement not covered" >return arr; </span></span>}
&nbsp;
function <span class="fstat-no" title="function not covered" >asyncGeneratorStep(</span>gen, resolve, reject, _next, _throw, key, arg) { <span class="cstat-no" title="statement not covered" >try { var info = <span class="cstat-no" title="statement not covered" >gen[key](arg);</span> var value = <span class="cstat-no" title="statement not covered" >info.value;</span> } catch (error) { <span class="cstat-no" title="statement not covered" >reject(error); <span class="cstat-no" title="statement not covered" ></span>return; </span>} <span class="cstat-no" title="statement not covered" ></span>if (info.done) { <span class="cstat-no" title="statement not covered" >resolve(value); </span>} else { <span class="cstat-no" title="statement not covered" >Promise.resolve(value).then(_next, _throw); </span>} </span>}
&nbsp;
function <span class="fstat-no" title="function not covered" >_asyncToGenerator(</span>fn) { <span class="cstat-no" title="statement not covered" >return <span class="fstat-no" title="function not covered" >fu</span>nction () { var self = <span class="cstat-no" title="statement not covered" >this,</span> args = <span class="cstat-no" title="statement not covered" >arguments;</span> <span class="cstat-no" title="statement not covered" >return new Promise(<span class="fstat-no" title="function not covered" >fu</span>nction (resolve, reject) { var gen = <span class="cstat-no" title="statement not covered" >fn.apply(self, args);</span> function <span class="fstat-no" title="function not covered" >_next(</span>value) { <span class="cstat-no" title="statement not covered" >asyncGeneratorStep(gen, resolve, reject, _next, _throw, "next", value); </span>} function <span class="fstat-no" title="function not covered" >_throw(</span>err) { <span class="cstat-no" title="statement not covered" >asyncGeneratorStep(gen, resolve, reject, _next, _throw, "throw", err); </span>} <span class="cstat-no" title="statement not covered" >_next(undefined); </span>}); </span>}; </span>}
&nbsp;
const basename = require('path').basename;
&nbsp;
const parseUrl = require('url').parse;
&nbsp;
const debug = require('debug')('sanity:import');
&nbsp;
const pMap = require('p-map');
&nbsp;
const progressStepper = require('./util/progressStepper');
&nbsp;
const getHashedBufferForUri = require('./util/getHashedBufferForUri');
&nbsp;
const retryOnFailure = require('./util/retryOnFailure');
&nbsp;
const ASSET_UPLOAD_CONCURRENCY = 3;
const ASSET_PATCH_CONCURRENCY = 3;
const ASSET_PATCH_BATCH_SIZE = 50;
&nbsp;
function <span class="fstat-no" title="function not covered" >uploadAssets(</span>_x, _x2) {
<span class="cstat-no" title="statement not covered" >  return _uploadAssets.apply(this, arguments);</span>
}
&nbsp;
function <span class="fstat-no" title="function not covered" >_uploadAssets(</span>) {
<span class="cstat-no" title="statement not covered" >  _uploadAssets = _asyncToGenerator(<span class="fstat-no" title="function not covered" >fu</span>nction* (assets, options) {</span>
    // Build a Map where the keys are `type#url` and the value is an array of all
    // objects containing document id and path to inject asset reference to.
    // `assets` is an array of objects with shape: {documentId, path, url, type}
    const assetRefMap = <span class="cstat-no" title="statement not covered" >getAssetRefMap(assets) </span>// We might have additional assets that is not referenced by any documents, but was part of a
    // dataset when exporting, for instance. Add these to the map without any references to update.
    ;
<span class="cstat-no" title="statement not covered" >    (options.unreferencedAssets || []).forEach(<span class="fstat-no" title="function not covered" >as</span>set =&gt; {</span>
<span class="cstat-no" title="statement not covered" >      if (!assetRefMap.has(asset)) {</span>
<span class="cstat-no" title="statement not covered" >        assetRefMap.set(asset, []);</span>
      }
    });
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (assetRefMap.size === 0) {</span>
<span class="cstat-no" title="statement not covered" >      return {</span>
        batches: [0],
        failures: []
      };
    } // Create a function we can call for every completed upload to report progress
&nbsp;
&nbsp;
    const progress = <span class="cstat-no" title="statement not covered" >progressStepper(options.onProgress, {</span>
      step: 'Importing assets (files/images)',
      total: assetRefMap.size
    }); // If we should allow failures, we need to use a custom catch handler in order
    // to not set the asset references for the broken assets
&nbsp;
    const ensureAssetExists = <span class="cstat-no" title="statement not covered" >ensureAssetWithRetries.bind(null, options, progress);</span>
    const ensureMethod = <span class="cstat-no" title="statement not covered" >options.allowFailingAssets ? <span class="fstat-no" title="function not covered" >(.</span>..args) =&gt; <span class="cstat-no" title="statement not covered" >ensureAssetExists(...args).catch(<span class="fstat-no" title="function not covered" >er</span>r =&gt; <span class="cstat-no" title="statement not covered" >err)</span> </span>: ensureAssetExists;</span> // Loop over all unique URLs and ensure they exist, and if not, upload them
&nbsp;
    const mapOptions = <span class="cstat-no" title="statement not covered" >{</span>
      concurrency: ASSET_UPLOAD_CONCURRENCY
    };
    const assetIds = <span class="cstat-no" title="statement not covered" >yield pMap(assetRefMap.keys(), ensureMethod, mapOptions);</span> // Extract a list of all failures so we may report them and possibly retry them later
&nbsp;
    const assetFailures = <span class="cstat-no" title="statement not covered" >getUploadFailures(assetRefMap, assetIds);</span> // Loop over all documents that need asset references to be set
&nbsp;
    const batches = <span class="cstat-no" title="statement not covered" >yield setAssetReferences(assetRefMap, assetIds, options);</span>
<span class="cstat-no" title="statement not covered" >    return {</span>
      batches: batches.reduce(<span class="fstat-no" title="function not covered" >(p</span>rev, add) =&gt; <span class="cstat-no" title="statement not covered" >prev + add,</span> 0),
      failures: assetFailures
    };
  });
<span class="cstat-no" title="statement not covered" >  return _uploadAssets.apply(this, arguments);</span>
}
&nbsp;
function <span class="fstat-no" title="function not covered" >getAssetRefMap(</span>assets) {
<span class="cstat-no" title="statement not covered" >  return assets.reduce(<span class="fstat-no" title="function not covered" >(a</span>ssetRefMap, item) =&gt; {</span>
    const documentId = <span class="cstat-no" title="statement not covered" >item.documentId,</span>
          path = <span class="cstat-no" title="statement not covered" >item.path,</span>
          url = <span class="cstat-no" title="statement not covered" >item.url,</span>
          type = <span class="cstat-no" title="statement not covered" >item.type;</span>
    const key = <span class="cstat-no" title="statement not covered" >`${type}#${url}`;</span>
    let refs = <span class="cstat-no" title="statement not covered" >assetRefMap.get(key);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (!refs) {</span>
<span class="cstat-no" title="statement not covered" >      refs = [];</span>
<span class="cstat-no" title="statement not covered" >      assetRefMap.set(key, refs);</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    refs.push({</span>
      documentId,
      path
    });
<span class="cstat-no" title="statement not covered" >    return assetRefMap;</span>
  }, new Map());
}
&nbsp;
function <span class="fstat-no" title="function not covered" >ensureAssetWithRetries(</span>_x3, _x4, _x5, _x6) {
<span class="cstat-no" title="statement not covered" >  return _ensureAssetWithRetries.apply(this, arguments);</span>
}
&nbsp;
function <span class="fstat-no" title="function not covered" >_ensureAssetWithRetries(</span>) {
<span class="cstat-no" title="statement not covered" >  _ensureAssetWithRetries = _asyncToGenerator(<span class="fstat-no" title="function not covered" >fu</span>nction* (options, progress, assetKey, i) {</span>
    const _assetKey$split = <span class="cstat-no" title="statement not covered" >assetKey.split('#', 2),</span>
          _assetKey$split2 = <span class="cstat-no" title="statement not covered" >_slicedToArray(_assetKey$split, 2),</span>
          type = <span class="cstat-no" title="statement not covered" >_assetKey$split2[0],</span>
          url = <span class="cstat-no" title="statement not covered" >_assetKey$split2[1];</span>
&nbsp;
    const _ref = <span class="cstat-no" title="statement not covered" >yield retryOnFailure(<span class="fstat-no" title="function not covered" >()</span> =&gt; <span class="cstat-no" title="statement not covered" >downloadAsset(url, i))</span>.catch(<span class="fstat-no" title="function not covered" >er</span>r =&gt; {</span>
<span class="cstat-no" title="statement not covered" >      progress();</span>
<span class="cstat-no" title="statement not covered" >      err.type = type;</span>
<span class="cstat-no" title="statement not covered" >      err.url = url;</span>
<span class="cstat-no" title="statement not covered" >      err.message = err.message.includes(url) ? err.message : `Failed to download ${type} @ ${url}:\n${err.message}`;</span>
<span class="cstat-no" title="statement not covered" >      throw err;</span>
    }),
          buffer = <span class="cstat-no" title="statement not covered" >_ref.buffer,</span>
          sha1hash = <span class="cstat-no" title="statement not covered" >_ref.sha1hash;</span>
&nbsp;
    const asset = <span class="cstat-no" title="statement not covered" >{</span>
      buffer,
      sha1hash,
      type,
      url
    };
<span class="cstat-no" title="statement not covered" >    return retryOnFailure(<span class="fstat-no" title="function not covered" >()</span> =&gt; <span class="cstat-no" title="statement not covered" >ensureAsset(asset, options, i))</span>.then(progress).catch(<span class="fstat-no" title="function not covered" >er</span>r =&gt; {</span>
<span class="cstat-no" title="statement not covered" >      progress();</span>
<span class="cstat-no" title="statement not covered" >      err.type = type;</span>
<span class="cstat-no" title="statement not covered" >      err.url = url;</span>
<span class="cstat-no" title="statement not covered" >      err.message = err.message.includes(url) ? err.message : `Failed to upload ${type} @ ${url}:\n${err.message}`;</span>
<span class="cstat-no" title="statement not covered" >      throw err;</span>
    });
  });
<span class="cstat-no" title="statement not covered" >  return _ensureAssetWithRetries.apply(this, arguments);</span>
}
&nbsp;
function <span class="fstat-no" title="function not covered" >downloadAsset(</span>url, i) {
  // Download the asset in order for us to create a hash
<span class="cstat-no" title="statement not covered" >  debug('[Asset #%d] Downloading %s', i, url);</span>
<span class="cstat-no" title="statement not covered" >  return getHashedBufferForUri(url);</span>
}
&nbsp;
function <span class="fstat-no" title="function not covered" >ensureAsset(</span>_x7, _x8, _x9) {
<span class="cstat-no" title="statement not covered" >  return _ensureAsset.apply(this, arguments);</span>
}
&nbsp;
function <span class="fstat-no" title="function not covered" >_ensureAsset(</span>) {
<span class="cstat-no" title="statement not covered" >  _ensureAsset = _asyncToGenerator(<span class="fstat-no" title="function not covered" >fu</span>nction* (asset, options, i) {</span>
    const buffer = <span class="cstat-no" title="statement not covered" >asset.buffer,</span>
          sha1hash = <span class="cstat-no" title="statement not covered" >asset.sha1hash,</span>
          type = <span class="cstat-no" title="statement not covered" >asset.type,</span>
          url = <span class="cstat-no" title="statement not covered" >asset.url;</span>
    const client = <span class="cstat-no" title="statement not covered" >options.client,</span>
          _options$assetMap = <span class="cstat-no" title="statement not covered" >options.assetMap,</span>
          assetMap = <span class="cstat-no" title="statement not covered" >_options$assetMap === void 0 ? {} : _options$assetMap;</span> // See if the item exists on the server
&nbsp;
<span class="cstat-no" title="statement not covered" >    debug('[Asset #%d] Checking for asset with hash %s', i, sha1hash);</span>
    const assetDocId = <span class="cstat-no" title="statement not covered" >yield getAssetDocumentIdForHash(client, type, sha1hash);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (assetDocId) {</span>
      // Same hash means we want to reuse the asset
<span class="cstat-no" title="statement not covered" >      debug('[Asset #%d] Found %s for hash %s', i, type, sha1hash);</span>
<span class="cstat-no" title="statement not covered" >      return assetDocId;</span>
    }
&nbsp;
    const assetMeta = <span class="cstat-no" title="statement not covered" >assetMap[`${type}-${sha1hash}`];</span>
    const hasFilename = <span class="cstat-no" title="statement not covered" >assetMeta &amp;&amp; assetMeta.originalFilename;</span>
    const hasNonFilenameMeta = <span class="cstat-no" title="statement not covered" >assetMeta &amp;&amp; Object.keys(assetMap).length &gt; 1;</span>
&nbsp;
    const _parseUrl = <span class="cstat-no" title="statement not covered" >parseUrl(url),</span>
          pathname = <span class="cstat-no" title="statement not covered" >_parseUrl.pathname;</span>
&nbsp;
    const filename = <span class="cstat-no" title="statement not covered" >hasFilename ? assetMeta.originalFilename : basename(pathname);</span> // If it doesn't exist, we want to upload it
&nbsp;
<span class="cstat-no" title="statement not covered" >    debug('[Asset #%d] Uploading %s with URL %s', i, type, url);</span>
    const assetDoc = <span class="cstat-no" title="statement not covered" >yield client.assets.upload(type, buffer, {</span>
      filename
    }); // If we have more metadata to provide, update the asset document
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (hasNonFilenameMeta) {</span>
<span class="cstat-no" title="statement not covered" >      yield client.patch(assetDoc._id).set(assetMeta);</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    return assetDoc._id;</span>
  });
<span class="cstat-no" title="statement not covered" >  return _ensureAsset.apply(this, arguments);</span>
}
&nbsp;
function <span class="fstat-no" title="function not covered" >getAssetDocumentIdForHash(</span>_x10, _x11, _x12) {
<span class="cstat-no" title="statement not covered" >  return _getAssetDocumentIdForHash.apply(this, arguments);</span>
}
&nbsp;
function <span class="fstat-no" title="function not covered" >_getAssetDocumentIdForHash(</span>) {
<span class="cstat-no" title="statement not covered" >  _getAssetDocumentIdForHash = _asyncToGenerator(<span class="fstat-no" title="function not covered" >fu</span>nction* (client, type, sha1hash, attemptNum = <span class="branch-0 cbranch-no" title="branch not covered" >0)</span> {</span>
    // @todo remove retry logic when client has reintroduced it
<span class="cstat-no" title="statement not covered" >    try {</span>
      const dataType = <span class="cstat-no" title="statement not covered" >type === 'file' ? 'sanity.fileAsset' : 'sanity.imageAsset';</span>
      const query = <span class="cstat-no" title="statement not covered" >'*[_type == $dataType &amp;&amp; sha1hash == $sha1hash][0]._id';</span>
      const assetDocId = <span class="cstat-no" title="statement not covered" >yield client.fetch(query, {</span>
        dataType,
        sha1hash
      });
<span class="cstat-no" title="statement not covered" >      return assetDocId;</span>
    } catch (err) {
<span class="cstat-no" title="statement not covered" >      if (attemptNum &lt; 3) {</span>
<span class="cstat-no" title="statement not covered" >        return getAssetDocumentIdForHash(client, type, sha1hash, attemptNum + 1);</span>
      }
&nbsp;
<span class="cstat-no" title="statement not covered" >      err.attempts = attemptNum;</span>
<span class="cstat-no" title="statement not covered" >      throw new Error(`Error while attempt to query Sanity API:\n${err.message}`);</span>
    }
  });
<span class="cstat-no" title="statement not covered" >  return _getAssetDocumentIdForHash.apply(this, arguments);</span>
}
&nbsp;
function <span class="fstat-no" title="function not covered" >getUploadFailures(</span>assetRefMap, assetIds) {
  const lookup = <span class="cstat-no" title="statement not covered" >assetRefMap.values();</span>
<span class="cstat-no" title="statement not covered" >  return assetIds.reduce(<span class="fstat-no" title="function not covered" >(f</span>ailures, assetId) =&gt; {</span>
    const documents = <span class="cstat-no" title="statement not covered" >lookup.next().value;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (typeof assetId === 'string') {</span>
<span class="cstat-no" title="statement not covered" >      return failures;</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    return failures.concat({</span>
      type: 'asset',
      url: assetId.url,
      documents: documents.map(<span class="fstat-no" title="function not covered" >({</span>
        documentId,
        path
      }) =&gt; (<span class="cstat-no" title="statement not covered" >{</span>
        documentId,
        path
      }))
    });
  }, []);
}
&nbsp;
function <span class="fstat-no" title="function not covered" >setAssetReferences(</span>assetRefMap, assetIds, options) {
  const client = <span class="cstat-no" title="statement not covered" >options.client;</span>
  const lookup = <span class="cstat-no" title="statement not covered" >assetRefMap.values();</span>
  const patchTasks = <span class="cstat-no" title="statement not covered" >assetIds.reduce(<span class="fstat-no" title="function not covered" >(t</span>asks, assetId) =&gt; {</span>
    const documents = <span class="cstat-no" title="statement not covered" >lookup.next().value;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (typeof assetId !== 'string') {</span>
<span class="cstat-no" title="statement not covered" >      return tasks;</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    return tasks.concat(documents.map(<span class="fstat-no" title="function not covered" >({</span></span>
      documentId,
      path
    }) =&gt; (<span class="cstat-no" title="statement not covered" >{</span>
      documentId,
      path,
      assetId
    })));
  }, []); // We now have an array of simple tasks, each containing:
  // {documentId, path, assetId}
  // Instead of doing a single mutation per asset, let's batch them up
&nbsp;
  const batches = <span class="cstat-no" title="statement not covered" >[];</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  for (let i = 0; i &lt; patchTasks.length; i += ASSET_PATCH_BATCH_SIZE) {</span>
<span class="cstat-no" title="statement not covered" >    batches.push(patchTasks.slice(i, i + ASSET_PATCH_BATCH_SIZE));</span>
  }
&nbsp;
<span class="cstat-no" title="statement not covered" >  if (batches.length === 0) {</span>
<span class="cstat-no" title="statement not covered" >    return Promise.resolve([0]);</span>
  } // Since separate progress step for batches of reference sets
&nbsp;
&nbsp;
  const progress = <span class="cstat-no" title="statement not covered" >progressStepper(options.onProgress, {</span>
    step: 'Setting asset references to documents',
    total: batches.length
  }); // Now perform the batch operations in parallel with a given concurrency
&nbsp;
  const mapOptions = <span class="cstat-no" title="statement not covered" >{</span>
    concurrency: ASSET_PATCH_CONCURRENCY
  };
  const setAssetRefs = <span class="cstat-no" title="statement not covered" >setAssetReferenceBatch.bind(null, client, progress);</span>
<span class="cstat-no" title="statement not covered" >  return pMap(batches, setAssetRefs, mapOptions);</span>
}
&nbsp;
function <span class="fstat-no" title="function not covered" >setAssetReferenceBatch(</span>client, progress, batch) {
<span class="cstat-no" title="statement not covered" >  debug('Setting asset references on %d documents', batch.length);</span>
<span class="cstat-no" title="statement not covered" >  return retryOnFailure(<span class="fstat-no" title="function not covered" >()</span> =&gt; <span class="cstat-no" title="statement not covered" >batch.reduce(reducePatch, client.transaction()).commit({</span></span>
    visibility: 'async'
  }).then(progress).then(<span class="fstat-no" title="function not covered" >re</span>s =&gt; <span class="cstat-no" title="statement not covered" >res.results.length)</span>);
}
&nbsp;
function <span class="fstat-no" title="function not covered" >getAssetType(</span>assetId) {
<span class="cstat-no" title="statement not covered" >  return assetId.slice(0, assetId.indexOf('-'));</span>
}
&nbsp;
function <span class="fstat-no" title="function not covered" >reducePatch(</span>trx, task) {
<span class="cstat-no" title="statement not covered" >  return trx.patch(task.documentId, <span class="fstat-no" title="function not covered" >pa</span>tch =&gt; <span class="cstat-no" title="statement not covered" >patch.setIfMissing({</span></span>
    [task.path]: {}
  }).set({
    [`${task.path}._type`]: getAssetType(task.assetId),
    [`${task.path}.asset`]: {
      _type: 'reference',
      _ref: task.assetId
    }
  }));
}
&nbsp;
module.exports = uploadAssets;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="https://istanbul.js.org/" target="_blank">istanbul</a> at Wed Dec 12 2018 17:04:52 GMT+0100 (Central European Standard Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
