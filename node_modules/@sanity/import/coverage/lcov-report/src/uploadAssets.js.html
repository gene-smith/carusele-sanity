<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for src/uploadAssets.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">All files</a> / <a href="index.html">src</a> uploadAssets.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">14.29% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>16/112</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">8.33% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>3/36</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">7.41% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>2/27</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">14.68% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>16/109</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250</td><td class="line-coverage quiet"><span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">const basename = require('path').basename
const parseUrl = require('url').parse
const debug = require('debug')('sanity:import')
const pMap = require('p-map')
const progressStepper = require('./util/progressStepper')
const getHashedBufferForUri = require('./util/getHashedBufferForUri')
const retryOnFailure = require('./util/retryOnFailure')
&nbsp;
const ASSET_UPLOAD_CONCURRENCY = 3
const ASSET_PATCH_CONCURRENCY = 3
const ASSET_PATCH_BATCH_SIZE = 50
&nbsp;
async function uploadAssets(assets, options) {
  // Build a Map where the keys are `type#url` and the value is an array of all
  // objects containing document id and path to inject asset reference to.
  // `assets` is an array of objects with shape: {documentId, path, url, type}
  const assetRefMap = getAssetRefMap(assets)
&nbsp;
  // We might have additional assets that is not referenced by any documents, but was part of a
  // dataset when exporting, for instance. Add these to the map without any references to update.
  ;(options.unreferencedAssets || []).forEach(<span class="fstat-no" title="function not covered" >as</span>set =&gt; {
<span class="cstat-no" title="statement not covered" >    if (!assetRefMap.has(asset)) {</span>
<span class="cstat-no" title="statement not covered" >      assetRefMap.set(asset, [])</span>
    }
  })
&nbsp;
  <span class="missing-if-branch" title="else path not taken" >E</span>if (assetRefMap.size === 0) {
    return {
      batches: [0],
      failures: []
    }
  }
&nbsp;
  // Create a function we can call for every completed upload to report progress
  const progress = <span class="cstat-no" title="statement not covered" >progressStepper(options.onProgress, {</span>
    step: 'Importing assets (files/images)',
    total: assetRefMap.size
  })
&nbsp;
  // If we should allow failures, we need to use a custom catch handler in order
  // to not set the asset references for the broken assets
  const ensureAssetExists = <span class="cstat-no" title="statement not covered" >ensureAssetWithRetries.bind(null, options, progress)</span>
  const ensureMethod = <span class="cstat-no" title="statement not covered" >options.allowFailingAssets</span>
    ? <span class="fstat-no" title="function not covered" >(.</span>..args) =&gt; <span class="cstat-no" title="statement not covered" >ensureAssetExists(...args).catch(<span class="fstat-no" title="function not covered" >er</span>r =&gt; <span class="cstat-no" title="statement not covered" >err)</span></span>
    : ensureAssetExists
&nbsp;
  // Loop over all unique URLs and ensure they exist, and if not, upload them
  const mapOptions = <span class="cstat-no" title="statement not covered" >{concurrency: ASSET_UPLOAD_CONCURRENCY}</span>
  const assetIds = <span class="cstat-no" title="statement not covered" >await pMap(assetRefMap.keys(), ensureMethod, mapOptions)</span>
&nbsp;
  // Extract a list of all failures so we may report them and possibly retry them later
  const assetFailures = <span class="cstat-no" title="statement not covered" >getUploadFailures(assetRefMap, assetIds)</span>
&nbsp;
  // Loop over all documents that need asset references to be set
  const batches = <span class="cstat-no" title="statement not covered" >await setAssetReferences(assetRefMap, assetIds, options)</span>
<span class="cstat-no" title="statement not covered" >  return {</span>
    batches: batches.reduce(<span class="fstat-no" title="function not covered" >(p</span>rev, add) =&gt; <span class="cstat-no" title="statement not covered" >prev + add,</span> 0),
    failures: assetFailures
  }
}
&nbsp;
function getAssetRefMap(assets) {
  return assets.reduce(<span class="fstat-no" title="function not covered" >(a</span>ssetRefMap, item) =&gt; {
    const {documentId, path, url, type} = <span class="cstat-no" title="statement not covered" >item</span>
    const key = <span class="cstat-no" title="statement not covered" >`${type}#${url}`</span>
    let refs = <span class="cstat-no" title="statement not covered" >assetRefMap.get(key)</span>
<span class="cstat-no" title="statement not covered" >    if (!refs) {</span>
<span class="cstat-no" title="statement not covered" >      refs = []</span>
<span class="cstat-no" title="statement not covered" >      assetRefMap.set(key, refs)</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    refs.push({documentId, path})</span>
<span class="cstat-no" title="statement not covered" >    return assetRefMap</span>
  }, new Map())
}
&nbsp;
async function <span class="fstat-no" title="function not covered" >ensureAssetWithRetries(</span>options, progress, assetKey, i) {
  const [type, url] = <span class="cstat-no" title="statement not covered" >assetKey.split('#', 2)</span>
&nbsp;
  const {buffer, sha1hash} = <span class="cstat-no" title="statement not covered" >await retryOnFailure(<span class="fstat-no" title="function not covered" >()</span> =&gt; <span class="cstat-no" title="statement not covered" >downloadAsset(url, i))</span>.catch(<span class="fstat-no" title="function not covered" >er</span>r =&gt; {</span>
<span class="cstat-no" title="statement not covered" >    progress()</span>
<span class="cstat-no" title="statement not covered" >    err.type = type</span>
<span class="cstat-no" title="statement not covered" >    err.url = url</span>
<span class="cstat-no" title="statement not covered" >    err.message = err.message.includes(url)</span>
      ? err.message
      : `Failed to download ${type} @ ${url}:\n${err.message}`
&nbsp;
<span class="cstat-no" title="statement not covered" >    throw err</span>
  })
&nbsp;
  const asset = <span class="cstat-no" title="statement not covered" >{buffer, sha1hash, type, url}</span>
<span class="cstat-no" title="statement not covered" >  return retryOnFailure(<span class="fstat-no" title="function not covered" >()</span> =&gt; <span class="cstat-no" title="statement not covered" >ensureAsset(asset, options, i))</span></span>
    .then(progress)
    .catch(<span class="fstat-no" title="function not covered" >er</span>r =&gt; {
<span class="cstat-no" title="statement not covered" >      progress()</span>
<span class="cstat-no" title="statement not covered" >      err.type = type</span>
<span class="cstat-no" title="statement not covered" >      err.url = url</span>
<span class="cstat-no" title="statement not covered" >      err.message = err.message.includes(url)</span>
        ? err.message
        : `Failed to upload ${type} @ ${url}:\n${err.message}`
&nbsp;
<span class="cstat-no" title="statement not covered" >      throw err</span>
    })
}
&nbsp;
function <span class="fstat-no" title="function not covered" >downloadAsset(</span>url, i) {
  // Download the asset in order for us to create a hash
<span class="cstat-no" title="statement not covered" >  debug('[Asset #%d] Downloading %s', i, url)</span>
<span class="cstat-no" title="statement not covered" >  return getHashedBufferForUri(url)</span>
}
&nbsp;
async function <span class="fstat-no" title="function not covered" >ensureAsset(</span>asset, options, i) {
  const {buffer, sha1hash, type, url} = <span class="cstat-no" title="statement not covered" >asset</span>
  const {client, assetMap = <span class="branch-0 cbranch-no" title="branch not covered" >{}}</span> = <span class="cstat-no" title="statement not covered" >options</span>
&nbsp;
  // See if the item exists on the server
<span class="cstat-no" title="statement not covered" >  debug('[Asset #%d] Checking for asset with hash %s', i, sha1hash)</span>
  const assetDocId = <span class="cstat-no" title="statement not covered" >await getAssetDocumentIdForHash(client, type, sha1hash)</span>
<span class="cstat-no" title="statement not covered" >  if (assetDocId) {</span>
    // Same hash means we want to reuse the asset
<span class="cstat-no" title="statement not covered" >    debug('[Asset #%d] Found %s for hash %s', i, type, sha1hash)</span>
<span class="cstat-no" title="statement not covered" >    return assetDocId</span>
  }
&nbsp;
  const assetMeta = <span class="cstat-no" title="statement not covered" >assetMap[`${type}-${sha1hash}`]</span>
  const hasFilename = <span class="cstat-no" title="statement not covered" >assetMeta &amp;&amp; assetMeta.originalFilename</span>
  const hasNonFilenameMeta = <span class="cstat-no" title="statement not covered" >assetMeta &amp;&amp; Object.keys(assetMap).length &gt; 1</span>
  const {pathname} = <span class="cstat-no" title="statement not covered" >parseUrl(url)</span>
  const filename = <span class="cstat-no" title="statement not covered" >hasFilename ? assetMeta.originalFilename : basename(pathname)</span>
&nbsp;
  // If it doesn't exist, we want to upload it
<span class="cstat-no" title="statement not covered" >  debug('[Asset #%d] Uploading %s with URL %s', i, type, url)</span>
  const assetDoc = <span class="cstat-no" title="statement not covered" >await client.assets.upload(type, buffer, {filename})</span>
&nbsp;
  // If we have more metadata to provide, update the asset document
<span class="cstat-no" title="statement not covered" >  if (hasNonFilenameMeta) {</span>
<span class="cstat-no" title="statement not covered" >    await client.patch(assetDoc._id).set(assetMeta)</span>
  }
&nbsp;
<span class="cstat-no" title="statement not covered" >  return assetDoc._id</span>
}
&nbsp;
async function <span class="fstat-no" title="function not covered" >getAssetDocumentIdForHash(</span>client, type, sha1hash, attemptNum = <span class="branch-0 cbranch-no" title="branch not covered" >0)</span> {
  // @todo remove retry logic when client has reintroduced it
<span class="cstat-no" title="statement not covered" >  try {</span>
    const dataType = <span class="cstat-no" title="statement not covered" >type === 'file' ? 'sanity.fileAsset' : 'sanity.imageAsset'</span>
    const query = <span class="cstat-no" title="statement not covered" >'*[_type == $dataType &amp;&amp; sha1hash == $sha1hash][0]._id'</span>
    const assetDocId = <span class="cstat-no" title="statement not covered" >await client.fetch(query, {dataType, sha1hash})</span>
<span class="cstat-no" title="statement not covered" >    return assetDocId</span>
  } catch (err) {
<span class="cstat-no" title="statement not covered" >    if (attemptNum &lt; 3) {</span>
<span class="cstat-no" title="statement not covered" >      return getAssetDocumentIdForHash(client, type, sha1hash, attemptNum + 1)</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    err.attempts = attemptNum</span>
<span class="cstat-no" title="statement not covered" >    throw new Error(`Error while attempt to query Sanity API:\n${err.message}`)</span>
  }
}
&nbsp;
function <span class="fstat-no" title="function not covered" >getUploadFailures(</span>assetRefMap, assetIds) {
  const lookup = <span class="cstat-no" title="statement not covered" >assetRefMap.values()</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  return assetIds.reduce(<span class="fstat-no" title="function not covered" >(f</span>ailures, assetId) =&gt; {</span>
    const documents = <span class="cstat-no" title="statement not covered" >lookup.next().value</span>
<span class="cstat-no" title="statement not covered" >    if (typeof assetId === 'string') {</span>
<span class="cstat-no" title="statement not covered" >      return failures</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    return failures.concat({</span>
      type: 'asset',
      url: assetId.url,
      documents: documents.map(<span class="fstat-no" title="function not covered" >({</span>documentId, path}) =&gt; (<span class="cstat-no" title="statement not covered" >{</span>
        documentId,
        path
      }))
    })
  }, [])
}
&nbsp;
function <span class="fstat-no" title="function not covered" >setAssetReferences(</span>assetRefMap, assetIds, options) {
  const {client} = <span class="cstat-no" title="statement not covered" >options</span>
  const lookup = <span class="cstat-no" title="statement not covered" >assetRefMap.values()</span>
  const patchTasks = <span class="cstat-no" title="statement not covered" >assetIds.reduce(<span class="fstat-no" title="function not covered" >(t</span>asks, assetId) =&gt; {</span>
    const documents = <span class="cstat-no" title="statement not covered" >lookup.next().value</span>
<span class="cstat-no" title="statement not covered" >    if (typeof assetId !== 'string') {</span>
<span class="cstat-no" title="statement not covered" >      return tasks</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    return tasks.concat(</span>
      documents.map(<span class="fstat-no" title="function not covered" >({</span>documentId, path}) =&gt; (<span class="cstat-no" title="statement not covered" >{</span>
        documentId,
        path,
        assetId
      }))
    )
  }, [])
&nbsp;
  // We now have an array of simple tasks, each containing:
  // {documentId, path, assetId}
  // Instead of doing a single mutation per asset, let's batch them up
  const batches = <span class="cstat-no" title="statement not covered" >[]</span>
<span class="cstat-no" title="statement not covered" >  for (let i = 0; i &lt; patchTasks.length; i += ASSET_PATCH_BATCH_SIZE) {</span>
<span class="cstat-no" title="statement not covered" >    batches.push(patchTasks.slice(i, i + ASSET_PATCH_BATCH_SIZE))</span>
  }
&nbsp;
<span class="cstat-no" title="statement not covered" >  if (batches.length === 0) {</span>
<span class="cstat-no" title="statement not covered" >    return Promise.resolve([0])</span>
  }
&nbsp;
  // Since separate progress step for batches of reference sets
  const progress = <span class="cstat-no" title="statement not covered" >progressStepper(options.onProgress, {</span>
    step: 'Setting asset references to documents',
    total: batches.length
  })
&nbsp;
  // Now perform the batch operations in parallel with a given concurrency
  const mapOptions = <span class="cstat-no" title="statement not covered" >{concurrency: ASSET_PATCH_CONCURRENCY}</span>
  const setAssetRefs = <span class="cstat-no" title="statement not covered" >setAssetReferenceBatch.bind(null, client, progress)</span>
<span class="cstat-no" title="statement not covered" >  return pMap(batches, setAssetRefs, mapOptions)</span>
}
&nbsp;
function <span class="fstat-no" title="function not covered" >setAssetReferenceBatch(</span>client, progress, batch) {
<span class="cstat-no" title="statement not covered" >  debug('Setting asset references on %d documents', batch.length)</span>
<span class="cstat-no" title="statement not covered" >  return retryOnFailure(<span class="fstat-no" title="function not covered" >()</span> =&gt;</span>
<span class="cstat-no" title="statement not covered" >    batch</span>
      .reduce(reducePatch, client.transaction())
      .commit({visibility: 'async'})
      .then(progress)
      .then(<span class="fstat-no" title="function not covered" >re</span>s =&gt; <span class="cstat-no" title="statement not covered" >res.results.length)</span>
  )
}
&nbsp;
function <span class="fstat-no" title="function not covered" >getAssetType(</span>assetId) {
<span class="cstat-no" title="statement not covered" >  return assetId.slice(0, assetId.indexOf('-'))</span>
}
&nbsp;
function <span class="fstat-no" title="function not covered" >reducePatch(</span>trx, task) {
<span class="cstat-no" title="statement not covered" >  return trx.patch(task.documentId, <span class="fstat-no" title="function not covered" >pa</span>tch =&gt;</span>
<span class="cstat-no" title="statement not covered" >    patch.setIfMissing({[task.path]: {}}).set({</span>
      [`${task.path}._type`]: getAssetType(task.assetId),
      [`${task.path}.asset`]: {
        _type: 'reference',
        _ref: task.assetId
      }
    })
  )
}
&nbsp;
module.exports = uploadAssets
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="https://istanbul.js.org/" target="_blank">istanbul</a> at Wed Dec 12 2018 17:08:02 GMT+0100 (Central European Standard Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
